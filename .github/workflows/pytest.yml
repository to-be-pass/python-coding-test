name: Run pytest

on:
  pull_request:
    branches:
      - solutions
      - '**/[0-9][0-9][0-9]'
    types:
      - opened
      - synchronize
jobs:

  extract-num:
    runs-on: ubuntu-latest

    outputs:
      num: ${{ steps.extract.outputs.num }}

    steps:
    - name: Checkout repository
      uses: actions/checkout@v4
    - name: Print Context
      run: | 
        echo ${{ github.ref }}
        echo ${{ github.ref_name }}
        echo ${{ github.head_ref }}
        echo ${{ github.action_status }}
        echo ${{ github.event_name }}
        echo ${{ github.event_path }}
    - name: Read solution number from Branch
      id: extract
      run: |
        echo "num=$(python ./script/get_number.py ${{ github.head_ref }})" >> $GITHUB_OUTPUT
    - name: Print solution number
      run: echo ${{ steps.extract.outputs.num }}
  
  extract-info:
    runs-on: ubuntu-latest
    needs: extract-num

    outputs:
      info: ${{ steps.extract-json.outputs.info }}
      
    steps:
      - name: Checkout repository
        uses: actions/checkout@v4
      - name: Print extract solution number
        run: echo ${{needs.extract-num.outputs.num }}
      - name: Read solution-info from JSON
        id: extract-json
        run: |
          cd ./script
          echo "info=$(python read_json.py ${{ needs.extract-num.outputs.num }})" >> $GITHUB_OUTPUT
      - name: Print solution info
        run: echo "${{ steps.extract-json.outputs.info }}"
        
  hello-comment:
    runs-on: ubuntu-latest
    needs: [extract-num, extract-info]

    steps:
      - name: Checkout repository
        uses: actions/checkout@v4
      
      - name: Print solution number annd info
        run: |
          echo ${{ needs.extract-num.outputs.num }} 
          echo "${{ needs.extract-info.outputs.info }}"

      - name: Auto Comment on Pull Request
        if: github.event_name == 'pull_request' && github.event.action == 'opened'
        uses: wow-actions/auto-comment@v1
        with:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
          pullRequestOpened: |
            ğŸ‘‹ @{{ author }} ë‹˜ ì•ˆë…•í•˜ì„¸ìš”!
            ì½”ë”© í…ŒìŠ¤íŠ¸ í•©ê²©ì ë˜ê¸°(íŒŒì´ì¬ í¸) : `ë¬¸ì œ ${{ needs.extract-num.outputs.num }}` ë¥¼ í’€ê³  ìˆìœ¼ì‹œë„¤ìš”!
            í•´ë‹¹ ë¬¸ì œì˜ ì±… í˜ì´ì§€ì™€ í”„ë¡œê·¸ë˜ë¨¸ìŠ¤ ë§í¬ë¥¼ ì•Œë ¤ë“œë¦´ê»˜ìš”!

            ${{ needs.extract-info.outputs.info }}
            
            1. í…ŒìŠ¤íŠ¸ê°€ ì‹¤íŒ¨í•œ ê²½ìš° ë‹¤ì‹œ í•œë²ˆ ë¬¸ì œë¥¼ í’€ì–´ì„œ `push` í•´ë³´ì„¸ìš”!
            2. ë¡œì»¬ì—ì„œ ë””ë²„ê¹…ë„ í•´ë³´ê³  ìŠ¤ìŠ¤ë¡œ ì½”ë©˜íŠ¸ë¥¼ ë‹¬ë©´ì„œ ê³µë¶€í•´ë³´ì„¸ìš”! 
            3. ë‹¤ì‹œ í•œë²ˆ ë¬¸ì œë¥¼ í’€ì–´ì„œ `push` í•´ë³´ì„¸ìš”!

  test:
    runs-on: ubuntu-latest
    needs: [extract-num, hello-comment]
    if: always()
    strategy:
      matrix:
        python-version:
          - '3.8'

    steps:
    - name: Checkout repository
      uses: actions/checkout@v4

    - name: Set up Python
      uses: actions/setup-python@v5
      with:
        python-version: ${{ matrix.python-version }}

    - name: Install dependencies
      run: |
        python -m pip install --upgrade pip
        pip install pytest python-dotenv

    - name: Run pytest
      run: pytest --id=${{ github.actor }} -k 'test_${{ needs.extract-num.outputs.num }}'

  create-and-add-label:
    runs-on: ubuntu-latest
    needs: [test, extract-num]
    if: always()
    steps:
    - name: Create and Add Label
      uses: actions/github-script@v5
      with:
        script: |
          const labelName = 'ë¬¸ì œ${{ needs.extract-num.outputs.num }}';
          const labelColor = 'ffffff'; // ë¼ë²¨ ìƒ‰ìƒì„ HEX ì½”ë“œë¡œ ì„¤ì •

          // ë¼ë²¨ì´ ì¡´ì¬í•˜ëŠ”ì§€ í™•ì¸
          try {
            await github.rest.issues.getLabel({
              owner: context.repo.owner,
              repo: context.repo.repo,
              name: labelName
            });
          } catch (error) {
            // ë¼ë²¨ì´ ì¡´ì¬í•˜ì§€ ì•Šìœ¼ë©´ ìƒì„±
            await github.rest.issues.createLabel({
              owner: context.repo.owner,
              repo: context.repo.repo,
              name: labelName,
              color: labelColor,
            });
          }

          // í’€ ë¦¬í€˜ìŠ¤íŠ¸ì— ë¼ë²¨ ì¶”ê°€
          await github.rest.issues.addLabels({
            issue_number: context.issue.number,
            owner: context.repo.owner,
            repo: context.repo.repo,
            labels: [labelName]
          });

  review-fail:
    runs-on: ubuntu-latest
    needs: [test, extract-num]
    if: failure()
    steps:
    - name: Remove Success Label if exists
      uses: actions/github-script@v5
      with:
        script: |
          const issue = await github.rest.issues.get({
            issue_number: context.issue.number,
            owner: context.repo.owner,
            repo: context.repo.repo
          });
          const hasFailLabel = issue.data.labels.some(label => label.name === 'pass');
          if (hasFailLabel) {
            // pass ë¼ë²¨ ì‚­ì œ
            await github.rest.issues.removeLabel({
              issue_number: context.issue.number,
              owner: context.repo.owner,
              repo: context.repo.repo,
              name: 'pass'
            });
          }
    - name: Add Fail Label
      uses: actions/github-script@v5
      with:
        script: |
          // fail ë¼ë²¨ ì¶”ê°€
          await github.rest.issues.addLabels({
            issue_number: context.issue.number,
            owner: context.repo.owner,
            repo: context.repo.repo,
            labels: ['fail']
          });
    - name: if fail test 
      uses: wow-actions/auto-comment@v1
      with:
        GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        pullRequestOpened: |
           âŒ @{{author}} ë‹˜. ì•„ì‰½ìŠµë‹ˆë‹¤.
           
           í…ŒìŠ¤íŠ¸ì— ì‹¤íŒ¨í–ˆìŠµë‹ˆë‹¤.
           ë‹¤ì‹œ í•œë²ˆ ë¬¸ì œë¥¼ í’€ê³ , `push` í•˜ê³  í…ŒìŠ¤íŠ¸ë¥¼ í†µê³¼í•´ë³´ì„¸ìš”!
           
           ë„ˆë¬´ ì–´ë ¤ìš°ì‹œë©´ ê°™ì€ ë¬¸ì œë¥¼ ë‹¤ë¥¸ ì‚¬ëŒë“¤ì€ ì–´ë–»ê²Œ í’€ê³ ìˆëŠ”ì§€ ì°¸ê³ ë„ í•´ë³´ì„¸ìš”!
           [ë¬¸ì œ ${{needs.extract-num.outputs.num}} - ë³´ëŸ¬ê°€ê¸°](${{github.server_url}}/${{github.repository}}/pulls?q=is%3Apr+label%3Aë¬¸ì œ${{needs.extract-num.outputs.num}}) 

        pullRequestSynchronize: |
           âŒ @{{author}} ë‹˜. ì•„ì‰½ìŠµë‹ˆë‹¤.
           
           í…ŒìŠ¤íŠ¸ì— ì‹¤íŒ¨í–ˆìŠµë‹ˆë‹¤.
           ë‹¤ì‹œ í•œë²ˆ ë¬¸ì œë¥¼ í’€ê³ , `push` í•˜ê³  í…ŒìŠ¤íŠ¸ë¥¼ í†µê³¼í•´ë³´ì„¸ìš”!

           ë„ˆë¬´ ì–´ë ¤ìš°ì‹œë©´ ê°™ì€ ë¬¸ì œë¥¼ ë‹¤ë¥¸ ì‚¬ëŒë“¤ì€ ì–´ë–»ê²Œ í’€ê³ ìˆëŠ”ì§€ ì°¸ê³ ë„ í•´ë³´ì„¸ìš”!
           [ë¬¸ì œ ${{needs.extract-num.outputs.num}} - ë³´ëŸ¬ê°€ê¸°](${{github.server_url}}/${{github.repository}}/pulls?q=is%3Apr+label%3Aë¬¸ì œ${{needs.extract-num.outputs.num}}) 

  review-pass:
    runs-on: ubuntu-latest
    needs: [extract-num, test]
    if: success()
    steps:
    - name: Remove Fail Label if exists
      uses: actions/github-script@v5
      with:
        script: |
          const issue = await github.rest.issues.get({
            issue_number: context.issue.number,
            owner: context.repo.owner,
            repo: context.repo.repo
          });
          const hasFailLabel = issue.data.labels.some(label => label.name === 'fail');
          if (hasFailLabel) {
            // fail ë¼ë²¨ ì‚­ì œ
            await github.rest.issues.removeLabel({
              issue_number: context.issue.number,
              owner: context.repo.owner,
              repo: context.repo.repo,
              name: 'fail'
            });
          }
          const hasHelpLabel = issue.data.labels.some(label => label.name === 'ë„ì›€ì´ í•„ìš”í•´ìš”!');
          if (hasHelpLabel) {
            // ë„ì›€ ë¼ë²¨ ì‚­ì œ
            await github.rest.issues.removeLabel({
              issue_number: context.issue.number,
              owner: context.repo.owner,
              repo: context.repo.repo,
              name: 'ë„ì›€ì´ í•„ìš”í•´ìš”!'
            });
          }
    - name: Add Fail Label
      uses: actions/github-script@v5
      with:
        script: |
          // pass ë¼ë²¨ ì¶”ê°€
          await github.rest.issues.addLabels({
            issue_number: context.issue.number,
            owner: context.repo.owner,
            repo: context.repo.repo,
            labels: ['pass']
          });
    - name: if pass test
      uses: wow-actions/auto-comment@v1
      with:
        GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}

        pullRequestOpened: |
            ğŸ‰ @{{ author }} ë‹˜. ì¶•í•˜ í•©ë‹ˆë‹¤! 
            
            ë¬¸ì œ `${{ needs.extract-num.outputs.num }}` í…ŒìŠ¤íŠ¸ë¥¼ í†µê³¼í•˜ì…¨ìŠµë‹ˆë‹¤!
            `solutons` ë¸Œëœì¹˜ì— Merge í•´ì£¼ì„¸ìš”!

            ë„ì›€ì´ í•„ìš”í•œ ì‚¬ëŒë“¤ì´ ìˆìœ¼ë©´ ë„ì™€ì£¼ì„¸ìš”! ì†Œí†µí•˜ë©´ì„œ ë” ì„±ì¥ í•  ìˆ˜ ìˆëŠ” ì¢‹ì€ ê¸°íšŒì…ë‹ˆë‹¤!
            [ë¬¸ì œ ${{needs.extract-num.outputs.num}} - ë„ì›€ì£¼ëŸ¬ ê°€ê¸°](${{github.server_url}}/${{github.repository}}/pulls?q=is%3Apr+label%3A"ë„ì›€ì´+í•„ìš”í•´ìš”%21"+label%3Aë¬¸ì œ${{needs.extract-num.outputs.num}})
    
        pullRequestSynchronize: |
            ğŸ‰ @{{ author }} ë‹˜. ì¶•í•˜ í•©ë‹ˆë‹¤! 
            
            ë¬¸ì œ `${{ needs.extract-num.outputs.num }}` í…ŒìŠ¤íŠ¸ë¥¼ í†µê³¼í•˜ì…¨ìŠµë‹ˆë‹¤!
            `solutons` ë¸Œëœì¹˜ì— Merge í•´ì£¼ì„¸ìš”!

            ë„ì›€ì´ í•„ìš”í•œ ì‚¬ëŒë“¤ì´ ìˆìœ¼ë©´ ë„ì™€ì£¼ì„¸ìš”! ì†Œí†µí•˜ë©´ì„œ ë” ì„±ì¥ í•  ìˆ˜ ìˆëŠ” ì¢‹ì€ ê¸°íšŒì…ë‹ˆë‹¤!
            [ë¬¸ì œ ${{needs.extract-num.outputs.num}} - ë„ì›€ì£¼ëŸ¬ ê°€ê¸°](${{github.server_url}}/${{github.repository}}/pulls?q=is%3Apr+label%3A"ë„ì›€ì´+í•„ìš”í•´ìš”%21"+label%3Aë¬¸ì œ${{needs.extract-num.outputs.num}})
    