name: Run pytest

on:
  pull_request:
    branches:
      - '**/ch_*'
    types:
      - opened
      - synchronize

jobs:

  extract_chapter:
    runs-on: ubuntu-latest

    outputs:
      chapter: ${{ steps.extract.outputs.chapter }}

    steps:
    - name: Extract Chapter
      id: extract
      run: echo "chapter=$(echo '$GITHUB_BASE_REF' | sed 's|refs/heads/||' | cut -d/ -f2-)" >> $GITHUB_OUTPUT
    - name: Prink Chapter
      run: echo ${{ steps.extract.outputs.chapter }}
  
  hello-comment:
    runs-on: ubuntu-latest

    steps:
      - name: Auto Comment on Pull Request
        if: github.event_name == 'pull_request' && github.event.action == 'opened'
        uses: wow-actions/auto-comment@v1
        with:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
          pullRequestOpened: |
            ğŸ‘‹ @{{ author }} ë‹˜ ì•ˆë…•í•˜ì„¸ìš”!
            
            1. PRì„ ìƒì„±í•˜ê³  `push` í•˜ê²Œ ë˜ë©´ ìë™ìœ¼ë¡œ í…ŒìŠ¤íŠ¸ê°€ ë™ì‘í•©ë‹ˆë‹¤.
            2. í…ŒìŠ¤íŠ¸ê°€ ì‹¤íŒ¨í•œ ê²½ìš° ë‹¤ì‹œ í•œë²ˆ ë¬¸ì œë¥¼ í’€ì–´ì„œ `push` í•´ë³´ì„¸ìš”!
            3. PRì´ ë“±ë¡ë˜ë©´ ë¦¬ë·°ì–´ í•œëª…ì´ ì§€ì •ë©ë‹ˆë‹¤. (ê°•ì œëŠ” ì•„ë‹™ë‹ˆë‹¤.)
            4. ìì‹ ì˜ ì½”ë“œë¥¼ ë¦¬ë·°ë„ ë°›ì•„ë³´ê³  ì§€ì •ëœ ë¦¬ë·°ë„ í•´ë³´ì„¸ìš”!

  test:
    runs-on: ubuntu-latest
    needs: extract_chapter

    strategy:
      matrix:
        python-version:
          - '3.8'

    steps:
    - name: Checkout repository
      uses: actions/checkout@v4

    - name: Set up Python
      uses: actions/setup-python@v5
      with:
        python-version: ${{ matrix.python-version }}

    - name: Install dependencies
      run: |
        python -m pip install --upgrade pip
        pip install pytest python-dotenv

    - name: Run pytest
      run: pytest --id=${{ github.actor }} -m ${{ needs.extract_chapter.outputs.chapter }}

  review-fail:
    runs-on: ubuntu-latest
    needs: test
    if: failure()
    steps:
    - name: if fail test 
      uses: wow-actions/auto-comment@v1
      with:
        GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}

        pullRequestSynchronize: |
           âŒ @{{author}} ë‹˜. ì•„ì‰½ìŠµë‹ˆë‹¤.
           
           í…ŒìŠ¤íŠ¸ì— ì‹¤íŒ¨í–ˆìŠµë‹ˆë‹¤.
           ë‹¤ì‹œ í•œë²ˆ ë¬¸ì œë¥¼ í’€ê³ , `push` í•˜ê³  í…ŒìŠ¤íŠ¸ë¥¼ í†µê³¼í•´ë³´ì„¸ìš”!

  review-pass:
    runs-on: ubuntu-latest
    needs: [test, extract_chapter]
    if: success()
    steps:
    - name: if pass test
      uses: wow-actions/auto-comment@v1
      with:
        GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}

        pullRequestSynchronize: |
            ğŸ‰ @{{ author }} ë‹˜. ì¶•í•˜ í•©ë‹ˆë‹¤! 
            
            testì— í†µê³¼í–ˆìŠµë‹ˆë‹¤!
            `${{ needs.extract_chapter.outputs.chapter }}` ë¸Œëœì¹˜ì— Merge í•´ì£¼ì„¸ìš”!
    
